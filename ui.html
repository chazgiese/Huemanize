<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Huemanize - Perceptual Color Interpolation</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased; /* Makes Inter look lighter to match Figma's UI*/
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision; 
    }

    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      width: 100%;
      max-width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    .main-layout {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      justify-content: flex-start;
      height: 100%;
    }

    .controls-panel {
      flex: 1;
      min-width: 0;
      border-right: 1px solid var(--figma-color-border);
      height: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .preview-panel {
      width: 120px;
      flex: 1;
      height: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .tabs {
      display: flex;
      column-gap: 4px;
      margin-right: -8px;
    }

    .tab {
      flex: 1;
      padding: 0 8px;
      height: 24px;
      text-align: center;
      font-size: 11px;
      letter-spacing: 0.05px;
      font-weight: 450;
      border-radius: 5px;
      cursor: default;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      color: var(--figma-color-text-tertiary);
    }

    .tab.active {
      color: var(--figma-color-text);
      background-color: var(--figma-color-bg-secondary);
    }

    .tab:hover {
      background-color: var(--figma-color-bg-secondary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .section {
      padding: 0 20px 12px;
      border-bottom: 1px solid var(--figma-color-border);
      margin-bottom: -1px;
      -webkit-user-select: none; /* Safari */
      -moz-user-select: none;    /* Firefox */
      -ms-user-select: none;     /* IE10+/Edge */
      user-select: none; 
      cursor: default;
    }

    .section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .section-title {
      display: flex;
      justify-content: space-between;
      flex-direction: row;
      height: 40px;
      align-items: center;
      font-size: 11px;
      font-weight: 450;
      letter-spacing: 0.05px;
      color: var(--figma-color-text);
      cursor: default;
    }

    .input-group {
      display: flex;
      align-items: center;
      height: 32px;
      padding: 4px 0;
      flex: 1 0 0;
      align-self: stretch;
      column-gap: 8px;
    }

    .input-container {
      position: relative;
      display: flex;
      flex: 1 0 0;
    }

    .input-container:hover input {
      border-color: var(--figma-color-border);
    }

    .input-container label {
      color: var(--figma-color-text-secondary);
      font-weight: 450;
      letter-spacing: 0.05px;
      font-size: 11px;
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    input, select {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      flex: 1 0 0;
      width: 0;
      padding: 0 0 0 4px;
      border-radius: 5px;
      border: 1px solid transparent;
      font-size: 11px;
      line-height: 16px;
      letter-spacing: 0.05px;
      height: 24px;
      outline: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      cursor: default;
    }

    input:hover, select:hover {
      border: 1px solid var(--figma-color-border);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--figma-color-border-selected) !important;
      box-shadow: none;
    }

    input[type="radio"] {
      border: 1px solid var(--figma-color-border);
      background: transparent;
    }

    input[type="radio"]:checked {
      border: 1px solid var(--figma-color-border-selected);
    }

    input[type="radio"]:checked + label {
      color: var(--figma-color-text);
    }

    input[type="number"] {
      -moz-appearance: textfield; /* Firefox */
      appearance: none;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none; /* Chrome, Safari, Edge */
      margin: 0;
    }

    .input-with-icon {
      padding-left: 24px;
    }

    .input-icon-container {
      position: absolute;
      left: 0;
      top: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .input-icon {
      width: 14px;
      height: 14px;
      cursor: ew-resize;
      user-select: none;
      transition: color 0.2s ease;
    }

    .input-icon svg {
      fill: var(--figma-color-text-secondary);
    }

    .input-icon:hover {
      color: var(--figma-color-text);
    }

    .input-icon:active {
      cursor: ew-resize;
    }

    .color-preview {
      width: 16px;
      height: 16px;
      border-radius: 2px;
      border: 1px solid var(--figma-color-border-disabled-strong);
      cursor: pointer;
    }

    .color-preview:hover {
      border-color: #18a0fb;
    }

    .color-scale {
      display: flex;
      flex-direction: column;
      margin-top: 4px;
      margin-bottom: 12px;
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid var(--figma-color-border);
    }

    .color-swatch {
      height: 32px;
      cursor: default;
      text-transform: uppercase;
      position: relative;
      display: flex;
      align-items: center;
      flex-direction: row;
      justify-content: space-between;
      padding: 8px 12px;
      font-size: 11px;
      letter-spacing: 0.05px;
      font-weight: 450;
      user-select: text;
    }

    /* WCAG AA contrast classes */
    .aa-white .scale-number,
    .aa-white .hex-code {
      color: #FFFFFF;
    }

    .aa-black .scale-number,
    .aa-black .hex-code {
      color: #000000;
    }

    .button {
      color: var(--figma-color-text);
      width: 100%;
      padding: 4px 8px;
      border: none;
      border-radius: 5px;
      font-size: 11px;
      line-height: 16px;
      letter-spacing: 0.05px;
      font-weight: 450;
      cursor: default;
      transition: all 0.2s ease;
      height: 24px;
    }

    .button-primary {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    .button-primary:pressed {
      background: var(--figma-color-bg-brand-pressed);
    }

    .button-secondary {
      background: #f0f0f0;
      color: #333;
      margin-bottom: 8px;
    }

    .button-secondary:hover {
      background: #e0e0e0;
    }

    .icon-button {
      width: 24px;
      height: 24px;
      background: transparent;
      border: none;
      border-radius: 5px;
      cursor: default;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: -4px;
    }

    .icon-button:hover {
      background: var(--figma-color-bg-secondary);
    }

    .icon-button svg {
      fill: var(--figma-color-text);
    }

    .error {
      color: #e74c3c;
      font-size: 12px;
      margin-top: 4px;
    }

    .success {
      color: #27ae60;
      font-size: 12px;
      margin-top: 4px;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .preview-placeholder {
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      letter-spacing: 0.05px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="main-layout">
    
    <div class="controls-panel">
      
      <div class="section">
        <div class="section-title">Base Color</div>
        <div class="input-group">
          <div class="input-container">
            <input type="text" class="input-with-icon" id="colorInput">
            <div class="input-icon-container">
              <div class="color-preview" id="colorPreview"></div>
            </div>
          </div>
          <button class="icon-button" id="randomizeButton">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12.25 2.62501V5.25001C12.25 5.36604 12.2039 5.47732 12.1219 5.55937C12.0398 5.64142 11.9285 5.68751 11.8125 5.68751H9.1875C9.07147 5.68751 8.96019 5.64142 8.87814 5.55937C8.79609 5.47732 8.75 5.36604 8.75 5.25001C8.75 5.13398 8.79609 5.0227 8.87814 4.94065C8.96019 4.8586 9.07147 4.81251 9.1875 4.81251H10.7565L9.95641 4.01243C9.1433 3.19562 8.03932 2.7348 6.8868 2.7311H6.86219C5.71931 2.72842 4.62132 3.17575 3.8057 3.97634C3.72215 4.05433 3.61139 4.09654 3.49713 4.09391C3.38286 4.09129 3.27415 4.04406 3.19426 3.96231C3.11438 3.88057 3.06965 3.7708 3.06966 3.65651C3.06966 3.54221 3.1144 3.43245 3.1943 3.35071C4.18279 2.3846 5.5124 1.84729 6.89458 1.85538C8.27676 1.86346 9.59999 2.4163 10.5771 3.39392L11.375 4.19399V2.62501C11.375 2.50898 11.4211 2.3977 11.5031 2.31565C11.5852 2.2336 11.6965 2.18751 11.8125 2.18751C11.9285 2.18751 12.0398 2.2336 12.1219 2.31565C12.2039 2.3977 12.25 2.50898 12.25 2.62501ZM10.1943 10.0237C9.37061 10.8283 8.26295 11.2757 7.11153 11.2689C5.96011 11.2622 4.85778 10.8018 4.04359 9.98759L3.24352 9.18751H4.8125C4.92853 9.18751 5.03981 9.14142 5.12186 9.05937C5.20391 8.97732 5.25 8.86604 5.25 8.75001C5.25 8.63398 5.20391 8.5227 5.12186 8.44065C5.03981 8.3586 4.92853 8.31251 4.8125 8.31251H2.1875C2.07147 8.31251 1.96019 8.3586 1.87814 8.44065C1.79609 8.5227 1.75 8.63398 1.75 8.75001V11.375C1.75 11.491 1.79609 11.6023 1.87814 11.6844C1.96019 11.7664 2.07147 11.8125 2.1875 11.8125C2.30353 11.8125 2.41481 11.7664 2.49686 11.6844C2.57891 11.6023 2.625 11.491 2.625 11.375V9.80603L3.42508 10.6061C4.40082 11.5868 5.726 12.1399 7.10938 12.1439H7.13836C8.50997 12.1474 9.82774 11.6105 10.8063 10.6493C10.8861 10.5676 10.9309 10.4578 10.9309 10.3435C10.9309 10.2292 10.8862 10.1195 10.8063 10.0377C10.7264 9.95596 10.6177 9.90873 10.5034 9.9061C10.3892 9.90348 10.2784 9.94568 10.1948 10.0237H10.1943Z" fill="inherit"/>
            </svg>
              
          </button>
        </div>
        <div id="colorError" class="error" style="display: none;"></div>
      </div>

      <div class="section">
        <div class="section-title">Interpolation Method</div>
        <div class="input-group">
          <div class="input-container">
            <select id="interpolationMethod" class="input-with-icon">
              <option value="linear">Linear</option>
              <option value="bezier">Bezier</option>
              <option value="catmull-rom">Catmull-Rom</option>
              <option value="ease-in">Ease In</option>
              <option value="ease-out">Ease Out</option>
              <option value="ease-in-out">Ease In-Out</option>
            </select>
            <div class="input-icon-container">
              <div class="input-icon">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M11.375 2.1875C11.375 2.30353 11.3289 2.41481 11.2469 2.49686C11.1648 2.57891 11.0535 2.625 10.9375 2.625H9.3357C9.02824 2.62492 8.7305 2.73278 8.49443 2.92977C8.25836 3.12676 8.09894 3.40038 8.04398 3.70289L7.52445 6.5625H10.0625C10.1785 6.5625 10.2898 6.60859 10.3719 6.69064C10.4539 6.77269 10.5 6.88397 10.5 7C10.5 7.11603 10.4539 7.22731 10.3719 7.30936C10.2898 7.39141 10.1785 7.4375 10.0625 7.4375H7.36531L6.81844 10.4541C6.72669 10.9584 6.46075 11.4144 6.06705 11.7427C5.67335 12.0709 5.17688 12.2505 4.6643 12.25H3.0625C2.94647 12.25 2.83519 12.2039 2.75314 12.1219C2.67109 12.0398 2.625 11.9285 2.625 11.8125C2.625 11.6965 2.67109 11.5852 2.75314 11.5031C2.83519 11.4211 2.94647 11.375 3.0625 11.375H4.6643C4.97176 11.3751 5.2695 11.2672 5.50557 11.0702C5.74164 10.8732 5.90106 10.5996 5.95602 10.2971L6.47555 7.4375H3.9375C3.82147 7.4375 3.71019 7.39141 3.62814 7.30936C3.54609 7.22731 3.5 7.11603 3.5 7C3.5 6.88397 3.54609 6.77269 3.62814 6.69064C3.71019 6.60859 3.82147 6.5625 3.9375 6.5625H6.63469L7.18156 3.54594C7.27331 3.04163 7.53925 2.58557 7.93295 2.25733C8.32665 1.9291 8.82312 1.74954 9.3357 1.75H10.9375C11.0535 1.75 11.1648 1.79609 11.2469 1.87814C11.3289 1.96019 11.375 2.07147 11.375 2.1875Z" fill="inherit"/>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Scale Settings</div>
        <div class="input-group">
          <div class="input-container">
            <input type="number" class="input-with-icon" id="stepsInput" value="11" min="2" max="21">
            <div class="input-icon-container">
              <div class="input-icon" id="stepsIcon" data-type="steps" data-min="2" data-max="21">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12.6279 9.40624C12.6857 9.50651 12.7014 9.6256 12.6715 9.73742C12.6417 9.84925 12.5688 9.9447 12.4688 10.0029L7.21875 13.0654C7.15185 13.1044 7.0758 13.1249 6.99836 13.1249C6.92092 13.1249 6.84487 13.1044 6.77797 13.0654L1.52797 10.0029C1.42936 9.94362 1.35806 9.84792 1.32951 9.73648C1.30095 9.62504 1.31744 9.50684 1.37539 9.40747C1.43335 9.30809 1.52811 9.23555 1.63916 9.20553C1.75022 9.17552 1.86863 9.19045 1.96875 9.2471L7 12.1811L12.0312 9.2471C12.1315 9.18931 12.2506 9.17362 12.3624 9.20344C12.4743 9.23327 12.5697 9.30619 12.6279 9.40624ZM12.0312 6.6221L7 9.55608L1.96875 6.6221C1.86913 6.5725 1.75436 6.56272 1.64779 6.59476C1.54122 6.6268 1.45087 6.69825 1.39512 6.79456C1.33937 6.89086 1.32241 7.0048 1.3477 7.11317C1.37299 7.22154 1.43863 7.3162 1.53125 7.37788L6.78125 10.4404C6.84815 10.4794 6.9242 10.4999 7.00164 10.4999C7.07908 10.4999 7.15513 10.4794 7.22203 10.4404L12.472 7.37788C12.5225 7.34935 12.5667 7.31109 12.6022 7.26532C12.6378 7.21955 12.6638 7.16718 12.6789 7.11125C12.6941 7.05532 12.6979 6.99694 12.6903 6.93951C12.6827 6.88208 12.6637 6.82673 12.6345 6.77669C12.6053 6.72664 12.5665 6.68289 12.5203 6.64797C12.474 6.61306 12.4213 6.58767 12.3652 6.57329C12.3091 6.55891 12.2507 6.55582 12.1933 6.5642C12.136 6.57257 12.0809 6.59225 12.0312 6.6221ZM1.3125 4.37499C1.31267 4.29836 1.33297 4.22312 1.37136 4.1568C1.40975 4.09048 1.46489 4.03541 1.53125 3.9971L6.78125 0.934596C6.84815 0.895586 6.9242 0.875031 7.00164 0.875031C7.07908 0.875031 7.15513 0.895586 7.22203 0.934596L12.472 3.9971C12.5381 4.03563 12.5929 4.09079 12.6309 4.1571C12.669 4.2234 12.6891 4.29853 12.6891 4.37499C12.6891 4.45145 12.669 4.52657 12.6309 4.59288C12.5929 4.65918 12.5381 4.71435 12.472 4.75288L7.22203 7.81538C7.15513 7.85439 7.07908 7.87494 7.00164 7.87494C6.9242 7.87494 6.84815 7.85439 6.78125 7.81538L1.53125 4.75288C1.46489 4.71456 1.40975 4.65949 1.37136 4.59317C1.33297 4.52685 1.31267 4.45162 1.3125 4.37499ZM2.61844 4.37499L7 6.93108L11.3816 4.37499L7 1.81889L2.61844 4.37499Z" fill="inherit"/>
                </svg>                  
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Export</div>
        <div class="input-group">
          <div class="input-container">
            <input type="text" id="groupNameInput" placeholder="Color name" maxlength="50">
          </div>
        </div>
        <div class="input-group">
          <div class="input-container">
            <input type="radio" id="exportBoth" name="exportMode" value="both" checked>
            <label for="exportBoth">All</label>
          </div>
          <div class="input-container">
            <input type="radio" id="exportLight" name="exportMode" value="light">
            <label for="exportLight">Light</label>
          </div>
          <div class="input-container">
            <input type="radio" id="exportDark" name="exportMode" value="dark">
            <label for="exportDark">Dark</label>
          </div>
        </div>
        <div class="input-group">
          <button class="button button-primary" id="addToFigmaBtn">Generate variables</button>
        </div>
        <div id="message" style="display: none;"></div>
      </div>
    </div>

    <div class="preview-panel">
      <div class="section" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0;">
        <div class="section-title" style="padding: 0 20px"><span>Preview</span>
          <div class="tabs">
            <div class="tab active" data-tab="light">Light</div>
            <div class="tab" data-tab="dark">Dark</div>
          </div>
        </div>
        <div class="tab-content active" id="light-tab-content" style="flex: 1; overflow-y: auto; padding: 0 20px;">
          <div class="color-scale" id="colorScaleLight">
            <div class="preview-placeholder">
              Generate a scale<br>to see preview
            </div>
          </div>
        </div>
        <div class="tab-content" id="dark-tab-content" style="flex: 1; overflow-y: auto; padding: 0 20px;">
          <div class="color-scale" id="colorScaleDark">
            <div class="preview-placeholder">
              Generate a scale<br>to see preview
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Color utilities
    function isValidHex(color) {
      return /^[0-9A-F]{6}$/i.test(color);
    }

    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }

    function rgbToHex(r, g, b) {
      return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }

    // UI Elements
    const colorInput = document.getElementById('colorInput');
    const colorPreview = document.getElementById('colorPreview');
    const colorError = document.getElementById('colorError');
    const interpolationMethod = document.getElementById('interpolationMethod');
    const stepsInput = document.getElementById('stepsInput');
    const stepsIcon = document.getElementById('stepsIcon');
    const groupNameInput = document.getElementById('groupNameInput');
    const colorScaleLight = document.getElementById('colorScaleLight');
    const colorScaleDark = document.getElementById('colorScaleDark');
    const addToFigmaBtn = document.getElementById('addToFigmaBtn');
    const message = document.getElementById('message');
    const exportModeRadios = document.querySelectorAll('input[name="exportMode"]');

    // Debounce function to prevent too many rapid calls
    let debounceTimer;
    function debounce(func, delay) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(func, delay);
    }

    // Event Listeners
    colorInput.addEventListener('input', updateColorPreview);
    colorInput.addEventListener('blur', formatHexInput);
    colorInput.addEventListener('keydown', handleHexInputKeydown);
    colorInput.addEventListener('focus', selectAllText);
    stepsInput.addEventListener('input', () => debounce(autoGenerateScale, 100));
    stepsInput.addEventListener('focus', selectAllText);
    groupNameInput.addEventListener('focus', selectAllText);
    interpolationMethod.addEventListener('change', () => debounce(autoGenerateScale, 100));
    addToFigmaBtn.addEventListener('click', addToFigma);
    randomizeButton.addEventListener('click', randomizeColor);
    exportModeRadios.forEach(radio => {
      radio.addEventListener('change', () => debounce(autoGenerateScale, 100));
    });

    // Drag functionality for scale settings
    setupDragIcon(stepsIcon, stepsInput);

    // Initialize
    updateColorPreview();
    
    // Auto-generate initial scale after a short delay to ensure UI is ready
    setTimeout(() => {
      const initialColor = colorInput.value.trim();
      if (initialColor && isValidHex(initialColor)) {
        autoGenerateScale();
      }
    }, 200);

    function updateColorPreview() {
      const color = colorInput.value;
      if (isValidHex(color)) {
        colorPreview.style.backgroundColor = '#' + color;
        colorError.style.display = 'none';
        debounce(autoGenerateScale, 150);
      } else {
        colorPreview.style.backgroundColor = '#f0f0f0';
        // Don't show error during typing, only on blur/enter
      }
    }

    function validateColor() {
      const color = colorInput.value;
      if (color && !isValidHex(color)) {
        colorError.textContent = 'Please enter a valid hex color (e.g., #FF6B6B)';
        colorError.style.display = 'block';
        return false;
      } else {
        colorError.style.display = 'none';
        return true;
      }
    }

    function selectAllText(e) {
      e.target.select();
    }

    // Hex color input validation and formatting
    function handleHexInputKeydown(e) {
      // Handle Enter key - format and blur
      if (e.keyCode === 13) {
        formatHexInput(e);
        e.target.blur();
        return;
      }
      
      // Allow: backspace, delete, tab, escape, and navigation keys
      if ([8, 9, 27, 46, 37, 38, 39, 40].includes(e.keyCode)) {
        return;
      }
      
      // Allow: numbers, letters A-F, and hash symbol
      const allowedChars = /[0-9A-Fa-f#]/;
      if (!allowedChars.test(e.key)) {
        e.preventDefault();
        return;
      }
      
      // Prevent multiple hash symbols
      if (e.key === '#' && e.target.value.includes('#')) {
        e.preventDefault();
        return;
      }
    }

    function formatHexInput(e) {
      const input = e.target;
      let value = input.value.trim().toUpperCase();
      
      // Remove hash symbol if present
      value = value.replace('#', '');
      
      // If empty, clear the input
      if (value === '') {
        input.value = '';
        colorError.style.display = 'none';
        return;
      }
      
      // Handle 3-character hex codes (expand to 6 characters like browsers do)
      if (value.length === 3 && /^[0-9A-F]{3}$/i.test(value)) {
        value = value.split('').map(char => char + char).join('');
      }
      
      // Keep only the first 6 characters if longer
      if (value.length > 6) {
        value = value.substring(0, 6);
      }
      
      // Validate hex format (6 characters, 0-9 or A-F)
      const hexRegex = /^[0-9A-F]{6}$/i;
      if (!hexRegex.test(value)) {
        // Try to fix invalid hex by replacing invalid characters
        let fixedValue = '';
        for (let i = 0; i < Math.min(value.length, 6); i++) {
          const char = value[i];
          if (/[0-9A-F]/i.test(char)) {
            fixedValue += char.toUpperCase();
          } else {
            // Replace invalid characters with '0'
            fixedValue += '0';
          }
        }
        
        // Pad to 6 characters if needed
        while (fixedValue.length < 6) {
          fixedValue += '0';
        }
        
        value = fixedValue;
      }
      
      // Format as uppercase without hash
      input.value = value.toUpperCase();
      colorError.style.display = 'none';
      
      // Update color preview and generate scale after formatting
      updateColorPreview();
    }



    function setupDragIcon(icon, input) {
      let isDragging = false;
      let startX = 0;
      let startValue = 0;
      const min = parseInt(icon.dataset.min);
      const max = parseInt(icon.dataset.max);

      function updateValue(value) {
        const clampedValue = Math.max(min, Math.min(max, value));
        input.value = clampedValue.toString();
        debounce(autoGenerateScale, 100);
      }

      function getCurrentValue() {
        const value = input.value.replace('%', '');
        return parseInt(value) || min;
      }

      icon.addEventListener('mousedown', (e) => {
        e.preventDefault();
        isDragging = true;
        startX = e.clientX;
        startValue = getCurrentValue();
        icon.classList.add('dragging');
        
        const handleMouseMove = (e) => {
          if (!isDragging) return;
          
          const deltaX = e.clientX - startX;
          const sensitivity = 2; // Adjust sensitivity
          const newValue = startValue + Math.round(deltaX / sensitivity);
          updateValue(newValue);
        };

        const handleMouseUp = () => {
          isDragging = false;
          icon.classList.remove('dragging');
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
      });
    }

    function autoGenerateScale() {
      const baseColor = colorInput.value.trim();
      
      // Don't generate if color is empty or invalid
      if (!baseColor || !isValidHex(baseColor)) {
        return;
      }
      
      const steps = parseInt(stepsInput.value) || 11;
      const method = interpolationMethod.value;
      const exportMode = Array.from(exportModeRadios).find(radio => radio.checked)?.value || 'light';

      // Send to plugin with hash symbol added
      parent.postMessage({
        pluginMessage: {
          type: 'generate-scale',
          baseColor: '#' + baseColor,
          steps,
          method,
          exportMode
        }
      }, '*');
    }

    function showMessage(text, type = 'success') {
      message.textContent = text;
      message.className = type;
      message.style.display = 'block';
      setTimeout(() => {
        message.style.display = 'none';
      }, 3000);
    }



    function addToFigma() {
      const baseColor = colorInput.value.trim();
      if (!baseColor || !isValidHex(baseColor)) {
        colorError.textContent = 'Please enter a valid hex color (e.g., FF6B6B)';
        colorError.style.display = 'block';
        return;
      }

      const steps = parseInt(stepsInput.value) || 11;
      const method = interpolationMethod.value;
      const groupName = groupNameInput.value.trim() || 'My Color Scale';
      const exportMode = Array.from(exportModeRadios).find(radio => radio.checked)?.value || 'light';

      parent.postMessage({
        pluginMessage: {
          type: 'add-to-figma',
          baseColor: '#' + baseColor,
          steps,
          method,
          groupName,
          exportMode
        }
      }, '*');

      addToFigmaBtn.classList.add('loading');
    }

    // Listen for messages from plugin
    window.addEventListener('message', (event) => {
      const { type, colors, darkColors, error, defaultColor } = event.data.pluginMessage;

      if (type === 'init' && defaultColor) {
        // Remove hash symbol if present and set as uppercase
        const cleanColor = defaultColor.replace('#', '').toUpperCase();
        colorInput.value = cleanColor;
        updateColorPreview();
      } else if (type === 'scale-generated') {
        displayColorScale(colors, 'light');
        if (darkColors) {
          displayColorScale(darkColors, 'dark');
        } else {
          // Show placeholder if no dark colors generated (fallback, should always be generated)
          colorScaleDark.innerHTML = '<div class="preview-placeholder">No dark mode colors generated.</div>';
        }
      } else if (type === 'added-to-figma') {
        showMessage('Color scale added to Figma variables!');
        addToFigmaBtn.classList.remove('loading');
      } else if (type === 'error') {
        showMessage(error, 'error');
        addToFigmaBtn.classList.remove('loading');
      }
    });

    // Generate random hex color
    function generateRandomHexColor() {
      const letters = '0123456789ABCDEF';
      let color = '';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    // Randomize color and generate scale
    function randomizeColor() {
      const randomColor = generateRandomHexColor();
      colorInput.value = randomColor;
      updateColorPreview();
      // The updateColorPreview function will trigger autoGenerateScale via debounce
    }

    // Calculate relative luminance for contrast ratio calculation
    function getRelativeLuminance(r, g, b) {
      const [rs, gs, bs] = [r, g, b].map(c => {
        c = c / 255;
        return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
      });
      return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
    }

    // Calculate contrast ratio between two colors
    function getContrastRatio(color1, color2) {
      const lum1 = getRelativeLuminance(color1.r, color1.g, color1.b);
      const lum2 = getRelativeLuminance(color2.r, color2.g, color2.b);
      const brightest = Math.max(lum1, lum2);
      const darkest = Math.min(lum1, lum2);
      return (brightest + 0.05) / (darkest + 0.05);
    }

    // Determine if white or black text provides better contrast (WCAG AA)
    function getBestContrastClass(hexColor) {
      // Parse hex color
      const r = parseInt(hexColor.slice(1, 3), 16);
      const g = parseInt(hexColor.slice(3, 5), 16);
      const b = parseInt(hexColor.slice(5, 7), 16);
      
      const backgroundColor = { r, g, b };
      const whiteText = { r: 255, g: 255, b: 255 };
      const blackText = { r: 0, g: 0, b: 0 };
      
      const whiteContrast = getContrastRatio(backgroundColor, whiteText);
      const blackContrast = getContrastRatio(backgroundColor, blackText);
      
      // WCAG AA standard for normal text is 4.5:1
      const wcagAAThreshold = 4.5;
      
      // Prefer white text if it meets WCAG AA standard
      if (whiteContrast >= wcagAAThreshold) {
        return 'aa-white';
      }
      
      // If white doesn't meet AA standard, use whichever has higher contrast
      return whiteContrast > blackContrast ? 'aa-white' : 'aa-black';
    }

    // Generate color numbers based on the number of steps
    function generateColorNumbers(steps) {
      const standardSteps = [50, 100, 200, 300, 400, 500, 600, 700, 800, 900, 950];
      
      if (steps === 11) {
        return standardSteps;
      } else if (steps < 11) {
        // For fewer steps, use the same names but skip some steps
        const indices = [];
        for (let i = 0; i < steps; i++) {
          const index = Math.round((i / (steps - 1)) * (standardSteps.length - 1));
          indices.push(index);
        }
        return indices.map(i => standardSteps[i]);
      } else {
        // For more steps, add intermediate values with 25 increments
        const numbers = [];
        
        // Calculate step size to distribute evenly across the range
        const stepSize = 900 / (steps - 1); // 900 is the range from 50 to 950
        
        for (let i = 0; i < steps; i++) {
          let number = Math.round(50 + (stepSize * i));
          
          // Round to nearest 25 for intermediate values (but keep 50 and 950 as is)
          if (number > 50 && number < 950) {
            number = Math.round(number / 25) * 25;
          }
          
          // Ensure we don't have duplicates and stay within bounds
          if (number < 50) number = 50;
          if (number > 950) number = 950;
          
          numbers.push(number);
        }
        
        // Remove duplicates and sort
        const uniqueNumbers = [...new Set(numbers)].sort((a, b) => a - b);
        
        // If we have fewer numbers than requested steps due to duplicates,
        // add more intermediate values
        if (uniqueNumbers.length < steps) {
          const additionalSteps = steps - uniqueNumbers.length;
          const gaps = [];
          
          // Find gaps between existing numbers
          for (let i = 0; i < uniqueNumbers.length - 1; i++) {
            const gap = uniqueNumbers[i + 1] - uniqueNumbers[i];
            if (gap > 25) {
              gaps.push({
                start: uniqueNumbers[i],
                end: uniqueNumbers[i + 1],
                size: gap
              });
            }
          }
          
          // Add intermediate values in the largest gaps
          gaps.sort((a, b) => b.size - a.size);
          
          for (let i = 0; i < Math.min(additionalSteps, gaps.length); i++) {
            const gap = gaps[i];
            const midPoint = Math.round((gap.start + gap.end) / 2 / 25) * 25;
            if (midPoint > gap.start && midPoint < gap.end) {
              uniqueNumbers.push(midPoint);
            }
          }
          
          return uniqueNumbers.sort((a, b) => a - b);
        }
        
        return uniqueNumbers;
      }
    }

    function displayColorScale(colors, mode) {
      const scaleElement = mode === 'light' ? colorScaleLight : colorScaleDark;
      
      if (colors.length === 0) {
        scaleElement.innerHTML = '<div class="preview-placeholder">No colors generated.</div>';
        return;
      }

      scaleElement.innerHTML = '';
      const colorNumbers = generateColorNumbers(colors.length);
      
      colors.forEach((color, index) => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        
        // Add WCAG AA contrast class
        const contrastClass = getBestContrastClass(color);
        swatch.classList.add(contrastClass);
        
        swatch.style.backgroundColor = color;
        swatch.setAttribute('data-color', color);
        swatch.title = color;
        
        // Create span for color scale number
        const scaleNumberSpan = document.createElement('span');
        scaleNumberSpan.className = 'scale-number';
        scaleNumberSpan.textContent = colorNumbers[index];
        
        // Create span for hex code
        const hexCodeSpan = document.createElement('span');
        hexCodeSpan.className = 'hex-code';
        hexCodeSpan.textContent = color;
        
        // Add spans to swatch
        swatch.appendChild(scaleNumberSpan);
        swatch.appendChild(hexCodeSpan);
        
        scaleElement.appendChild(swatch);
      });
    }

    // Tab functionality
    document.addEventListener('DOMContentLoaded', () => {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          
          // Update tab states
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Update tab content visibility
          tabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === `${targetTab}-tab-content`) {
              content.classList.add('active');
            }
          });
        });
      });
    });
  </script>
</body>
</html>
